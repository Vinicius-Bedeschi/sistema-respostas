<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Respostas Padrão</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,system-ui,Arial;background:#0b1220;color:#e6eef8;margin:0;padding:20px}
  .wrap{max-width:1100px;margin:0 auto}
  h1{margin:0 0 8px 0}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
  .card{background:linear-gradient(180deg,#071526,#041124);padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
  label{display:block;margin-top:8px;color:#9fb0c8}
  input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8}
  textarea{min-height:160px}
  .actions{display:flex;gap:8px;margin-top:10px}
  .btn{background:linear-gradient(90deg,#00ffd5,#0f62fe);color:#052; padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
  .small{font-size:13px;color:#9aa4b2}
  .list{max-height:640px;overflow:auto;margin-top:12px}
  .item{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Painel Administrativo — Respostas Padrão</h1>
    <p class="small">Adicione, edite ou remova respostas. Importação automática do .docx também disponível.</p>

    <div class="grid">
      <div class="card">
        <label>Categoria<input id="categoria"></label>
        <label>Subcategoria<input id="subcategoria"></label>
        <label>Título<input id="titulo"></label>
        <label>Versão<input id="versao" value="V1"></label>
        <label>Texto<textarea id="texto"></textarea></label>

        <div class="actions">
          <button class="btn" onclick="salvar()">Salvar</button>
          <button class="btn" style="background:#333" onclick="limpar()">Limpar</button>
          <button class="btn" style="background:#0b8f5a" onclick="document.getElementById('fileDocx').click()">Importar .docx</button>
        </div>

        <div style="margin-top:10px" class="small">Importar .docx tentará categorizar automaticamente; revise antes de salvar.</div>
        <input id="fileDocx" type="file" accept=".docx" style="display:none" onchange="importarDocx(event)">
      </div>

      <aside class="card">
        <h3>Respostas cadastradas</h3>
        <div class="list" id="lista"></div>
        <div style="margin-top:10px;display:flex;gap:8px">
          <button class="btn" onclick="carregarLista()">Atualizar</button>
          <button class="btn" style="background:#c62828" onclick="apagarTudo()">Apagar tudo</button>
        </div>
      </aside>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <script>
    const supabaseUrl = "https://blvtnplpbckvoqxkeelo.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJsdnRucGxwYmNrdm9xeGtlZWxvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MTI0MDIsImV4cCI6MjA3OTM4ODQwMn0.vPHgftig14JSgYe1O3RcXwaAhZoX1cfPmINKd04X9_w";
    const supabase = supabaseJs.createClient(supabaseUrl, supabaseAnonKey);

    let editando = null;

    async function carregarLista(){
      const { data, error } = await supabase.from('respostas').select('*').order('criado_em',{ascending:false});
      if (error){ console.error(error); alert('Erro ao carregar'); return; }
      const lista = document.getElementById('lista'); lista.innerHTML = '';
      if (!data.length) { lista.innerHTML = '<div class="small">Nenhuma resposta.</div>'; return; }
      data.forEach(it=>{
        const d = document.createElement('div'); d.className='item';
        d.innerHTML = `<div><strong>${it.titulo}</strong><div class="small">${it.categoria} • ${it.subcategoria||''}</div></div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="btn" style="background:#0b79d0" onclick="editar('${it.id}')">Editar</button>
          <button class="btn" style="background:#c62828" onclick="remover('${it.id}')">Deletar</button>
        </div>`;
        lista.appendChild(d);
      });
    }

    async function salvar(){
      const obj = {
        categoria: document.getElementById('categoria').value.trim(),
        subcategoria: document.getElementById('subcategoria').value.trim(),
        titulo: document.getElementById('titulo').value.trim(),
        versao: document.getElementById('versao').value.trim() || 'V1',
        texto: document.getElementById('texto').value.trim(),
        criado_em: new Date().toISOString()
      };
      if (!obj.categoria || !obj.titulo) { alert('Categoria e título obrigatórios'); return; }
      if (editando){
        const { error } = await supabase.from('respostas').update(obj).eq('id', editando);
        if (error){ console.error(error); alert('Erro ao atualizar'); return; }
        alert('Atualizado');
      } else {
        const { error } = await supabase.from('respostas').insert(obj);
        if (error){ console.error(error); alert('Erro ao salvar'); return; }
        alert('Salvo');
      }
      limpar(); carregarLista();
    }

    function limpar(){ editando=null; document.getElementById('categoria').value=''; document.getElementById('subcategoria').value=''; document.getElementById('titulo').value=''; document.getElementById('versao').value='V1'; document.getElementById('texto').value='';}

    async function editar(id){
      const { data, error } = await supabase.from('respostas').select('*').eq('id', id).limit(1).single();
      if (error){ console.error(error); return; }
      editando = id;
      document.getElementById('categoria').value = data.categoria || '';
      document.getElementById('subcategoria').value = data.subcategoria || '';
      document.getElementById('titulo').value = data.titulo || '';
      document.getElementById('versao').value = data.versao || 'V1';
      document.getElementById('texto').value = data.texto || '';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    async function remover(id){
      if (!confirm('Deletar?')) return;
      const { error } = await supabase.from('respostas').delete().eq('id', id);
      if (error){ console.error(error); alert('Erro'); return; }
      carregarLista();
    }

    async function apagarTudo(){
      if (!confirm('Apagar TODAS as respostas?')) return;
      // atenção: operação pesada, use com cuidado
      const { data } = await supabase.from('respostas').select('id');
      for (const r of data) {
        await supabase.from('respostas').delete().eq('id', r.id);
      }
      carregarLista();
    }

    // IMPORT .docx (client-side) -> tenta categorizar automaticamente (regras básicas)
    function importarDocx(e){
      const f = e.target.files[0];
      if (!f) return;
      mammoth.convertToHtml({arrayBuffer: f.arrayBuffer()})
        .then(async res => {
          const html = res.value;
          // separar por parágrafos e headings simples
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const nodes = Array.from(doc.body.childNodes);

          // strategy: cada H1/H2 considered title; paragraphs under as body until next heading
          const blocos = [];
          let cur = {titulo:'Sem título', texto:''};
          nodes.forEach(n => {
            if (n.nodeName.match(/^H[1-3]$/)) {
              if (cur.texto.trim()) blocos.push({...cur});
              cur = {titulo: n.textContent.trim(), texto: ''};
            } else {
              const txt = n.textContent.trim();
              if (txt) cur.texto += txt + "\n\n";
            }
          });
          if (cur.texto.trim()) blocos.push(cur);

          // para cada bloco, tenta categorizar e insere em supabase (sem salvar automaticamente, abre janela com preview)
          const preview = window.open('', '_blank');
          preview.document.write('<h3>Preview — blocos detectados (revise antes de salvar)</h3>');
          for (const b of blocos) {
            const categoria = categorizar(b.titulo + ' ' + b.texto);
            preview.document.write(`<div style="border:1px solid rgba(255,255,255,0.04);padding:12px;margin:8px;border-radius:8px"><b>Título:</b> ${escapeHtml(b.titulo)}<br><b>Categoria:</b> ${escapeHtml(categoria)}<pre style="white-space:pre-wrap;color:#ddd">${escapeHtml(b.texto)}</pre></div>`);
          }
          preview.document.title = 'Preview import .docx';
          alert('Arquivo convertido. Uma aba de pré-visualização foi aberta. Copie os blocos para o formulário e salve.');
        })
        .catch(err => { console.error(err); alert('Erro ao converter: '+err.message); });
    }

    // regra simples para categorizar automaticamente (keywords)
    function categorizar(texto){
      const t = (texto||'').toLowerCase();
      const mapas = [
        {cat:'Pontualidade', keys:['atras','adiant','pontual','horário','horario','passou']},
        {cat:'Motorista', keys:['motorista','condução','conduziu','parou','não parou','parada']},
        {cat:'Elogios', keys:['elogio','parabéns','agradecemos','muito bom','ótimo','otimo']},
        {cat:'Sugestões', keys:['sugest','melhor','sugestão','sugestao','proposta','melhoria']},
        {cat:'Achados e Perdidos', keys:['achado','perdido','perdi','item','objeto','achados']},
      ];
      for (const m of mapas){
        for (const k of m.keys){
          if (t.includes(k)) return m.cat;
        }
      }
      return 'Sem Dados';
    }

    carregarLista();
  </script>
</body>
</html>
